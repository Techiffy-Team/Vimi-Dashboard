<script setup>
import { useStyleState } from "@/composables/UseStyleState";
const { getStyleStatus } = useStyleState();
const props = defineProps({
  isPageLoading: {
    type: Boolean,
    required: true,
  },
  headers: {
    type: Array,
    required: true,
  },
  items: {
    type: Array,
    required: true,
  },
  routeDir: {
    type: String,
    required: true,
  },
  itemValue: {
    type: String,
    default: "uuid",
  },
  triggerResetSelectedItems: {
    type: Boolean,
    default: false,
  },
  triggerSelectAll: {
    default: false,
    type: Boolean,
  },
});

const router = useRouter();
const route = useRoute();

const viewDetails = (...event) => {
  router.push({
    name: `view-${props.routeDir}`,
    params: { id: event[1]?.item.uuid },
  });
};

const dateFormatting = (date) => {
  return new Date(date).toLocaleDateString("en-US");
};
const items = [
  {
    SKU: "#76459849",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Vitamins & Minerals",
    Type: "Variables",
    Qty: "185",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Brain Health",
    Type: "Simple",
    Qty: "10",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#764820",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Heart & Metabolism",
    Type: "Variables",
    Qty: "110",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459820",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Vitamins & Minerals",
    Type: "Bundle",
    Qty: "5",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#7645982",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Gut Health",
    Type: "Variables",
    Qty: "144",
    Price: "KD 20",
    Visability: "Published",
  },

  {
    SKU: "#764520",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Vitamins & Minerals",
    Type: "Simple",
    Qty: "6",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459819",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Heart & Metabolism",
    Type: "Variables",
    Qty: "210",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459818",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Gut Health",
    Type: "Bundle",
    Qty: "9",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459817",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Simple",
    Qty: "199",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459815",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Variables",
    Qty: "250",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459816",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Bundle",
    Qty: "400",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459814",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Simple",
    Qty: "250",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459813",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Simple",
    Qty: "250",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459812",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Variables",
    Qty: "250",
    Price: "KD 20",
    Visability: "Published",
  },
  {
    SKU: "#76459811",
    Product: "Lorem ipsum dolor sit ame consectetur.",
    Category: "Herbivore",
    Type: "Simple",
    Qty: "250",
    Price: "KD 20",
    Visability: "Published",
  },
  // ... more items
];

const orderStatus = ref([
  { nameAr: "قيد الانتظار", nameEn: "Pending" },
  {
    nameAr: "تم التسليم",
    nameEn: "Delivered",
  },
  {
    nameAr: "تم الشحن",
    nameEn: "Shipped",
  },
  {
    nameAr: "تم الاسترجاع",
    nameEn: "Returned",
  },
  {
    nameAr: "ملغي",
    nameEn: "Cancelled",
  },
  {
    nameAr: "في الانتظار",
    nameEn: "In progress",
  },
  {
    nameAr: "في انتظار الاسترجاع",
    nameEn: "Return in progress",
  },
  {
    nameAr: "مرفوض",
    nameEn: "Rejected",
  },
]);

const emit = defineEmits(["emitSelectedItems"], ["openDeleteModal"]);
//TODO: for discussion l8r how to make it dynamic
const headerLocal = computed(() => props.headers ?? headers);
const itemsLocal = computed(() => props.items ?? items);
let selectedItems = ref([]);

const selectItems = () => {
  emit("emitSelectedItems", selectedItems.value);
};

watch(
  () => props.triggerResetSelectedItems,
  () => {
    selectedItems.value = [];
  }
);

watch(
  () => props.triggerSelectAll,
  (val) => {
    if (val) {
      selectedItems.value = itemsLocal.value
        .map((item) => item[props.itemValue])
        .slice(0, 10);
    } else {
      selectedItems.value = [];
    }
    emit("emitSelectedItems", selectedItems.value);
  }
);

const openDeleteModal = ({ uuid }) => {
  emit("openDeleteModal", {
    uuid,
    options: {
      title: "Delete Product",
      text: "Are you sure you want to delete this Product ?",
      buttonTitle: "Yes, Delete",
      buttonColor: "#EB5757",
      icon: "deleteIcon",
      sheetColor: "#eb57571a",
    },
  });
};

const handleGoTOAction = ({ uuid }, action) => {
  const type = route.path.includes("products") ? "product" : "category";
  router.push({ name: `${action}-${type}`, params: { id: uuid } });
};
</script>

<template>
  <div classs="d-flex w-100">
    <dataTableLoader v-if="isPageLoading" />
    <v-data-table
      v-else-if="itemsLocal.length"
      v-bind="$attrs"
      v-model="selectedItems"
      class="listin-table"
      :headers="headerLocal"
      :items="itemsLocal"
      :item-value="itemValue"
      show-select
      :items-per-page="10"
      hide-default-footer
      @input="selectItems($event)"
      @click:row="viewDetails"
    >
      <template v-slot:item.uuid="{ item }">
        <div class="d-flex">
          <p class="py-1 text-subtitle-1">#{{ item.uuid.slice(0, 8) }}</p>
        </div>
      </template>

      <template v-slot:item.subCategoryCount="{ item }">
        <div>
          <p class="text-subtitle-1">{{ item.subCategoryCount }} sub</p>
        </div>
      </template>

      <template v-slot:item.id="{ item }">
        <div>
          <p class="product text-subtitle-1">{{ item.id }}</p>
        </div>
      </template>

      <template v-slot:item.title="{ item }">
        <div>
          <p class="product text-subtitle-1">{{ item.title }}</p>
        </div>
      </template>

      <template v-slot:item.description="{ item }">
        <div>
          <p class="product text-subtitle-1">{{ item.description }}</p>
        </div>
      </template>

      <template v-slot:item.creationDate="{ item }">
        <div>
          <p class="product text-subtitle-1">
            {{ item.creationDate }}
          </p>
        </div>
      </template>

      <template v-slot:item.respondDate="{ item }">
        <div>
          <p class="product text-subtitle-1">{{ item.respondDate }}</p>
        </div>
      </template>

      <template v-slot:item.productCount="{ item }">
        <div>
          <p
            class="text-subtitle-1"
            :style="{ color: item.productCount <= 10 ? '#EB5757' : '#21094A' }"
          >
            {{ item.productCount }}
          </p>
        </div>
      </template>

      <template v-slot:item.visibility="{ item }">
        <div class="d-flex">
          <p class="mx-auto green--tag px-2 py-1 text-subtitle-1">
            {{ item.visibility }}
          </p>
        </div>
      </template>

      <template v-slot:item.dateCreated="{ item }">
        <div class="d-flex">
          <p class="px-2 py-1 text-subtitle-1">
            {{ dateFormatting(item.dateCreated) }}
          </p>
        </div>
      </template>

      <template v-slot:item.price="{ item }">
        <div class="d-flex">
          <p class="price text-subtitle-1">
            KD
            {{ item.price }}
          </p>
        </div>
      </template>

      <template v-slot:item.stockQuantity="{ item }">
        <div class="d-flex">
          <p
            class="QTY text-subtitle-1"
            :class="item.stockQuantity <= 10 ? 'low' : ''"
          >
            {{ item.stockQuantity }}
          </p>
        </div>
      </template>

      <template v-slot:item.type="{ item }">
        <div class="d-flex">
          <p class="type text-subtitle-1">
            {{ item.type }}
          </p>
        </div>
      </template>

      <template v-slot:item.categoryName="{ item }">
        <div class="d-flex align-center justify-center">
          <p class="category text-subtitle-1">
            {{ item.categoryName }}
          </p>
        </div>
      </template>
      <template v-slot:item.displayName_En="{ item }">
        <div class="d-flex align-center">
          <div v-if="item.imagePath || item.images.length">
            <img
              style="width: 38px; height: 38px"
              :src="`https://techify-001-site1.htempurl.com${item.imagePath ? item.imagePath : item.images[0]?.imagePath}`"
              alt="product"
            />
          </div>
          <p class="product text-subtitle-1 ml-2">
            {{ item.displayName_En }}
          </p>
        </div>
      </template>

      <template v-slot:item.Customer="{ item }">
        <div class="d-flex align-center">
          <img src="@/assets/test-avatar.png" alt="avatar" />
          <p class="product text-subtitle-1 ml-2">
            {{ item.Customer }}
          </p>
        </div>
      </template>

      <template v-slot:item.sku="{ item }">
        <div class="d-flex">
          <p class="SKU text-subtitle-1">
            {{ item.sku }}
          </p>
        </div>
      </template>

      <template v-slot:item.orderNumber="{ item }">
        <div class="d-flex justify-center">
          <p class="SKU text-subtitle-1">
            {{ item.orderNumber }}
          </p>
        </div>
      </template>

      <template v-slot:item.orderDate="{ item }">
        <div class="d-flex justify-center">
          <p class="SKU text-subtitle-1">
            {{ item.orderDate }}
          </p>
        </div>
      </template>

      <template v-slot:item.Payment="{ item }">
        <div class="d-flex justify-center align-center" style="gap: 0.5rem">
          <SvgIcon :icon="item.paymentMethod" />
          <p class="SKU text-subtitle-1">
            {{ item.Payment }}
          </p>
        </div>
      </template>

      <template v-slot:item.Status="{ item }">
        <div class="d-flex justify-center">
          <VSelect
            :items="orderStatus"
            item-title="nameEn"
            item-value="nameEn"
            v-model="item.Status"
            density="compact"
            class="pa-0 w-100 pl-2 pb-1"
            variant="plain"
            hide-details
            style="
              max-width: 150px;
              font-size: 12px;
              padding: 0.2rem 0;
              border-radius: 8px;
            "
            :style="`background-color: ${getStyleStatus(item.Status)?.background}; color: ${getStyleStatus(item.Status)?.color}`"
          />
        </div>
      </template>

      <template v-slot:item.status="{ item }">
        <div class="d-flex">
          <p
            class="px-2 py-1 text-subtitle-1 mx-auto"
            style="
              max-width: 150px;
              font-size: 12px;
              padding: 0.2rem 0;
              border-radius: 8px;
            "
            :style="`background-color: ${getStyleStatus(item.status)?.background}; color: ${getStyleStatus(item.status)?.color}`"
          >
            {{ item.status }}
          </p>
        </div>
      </template>

      <template v-slot:item.actions="{ item }">
        <v-menu>
          <template v-slot:activator="{ props }">
            <v-btn flat v-bind="props">
              <v-icon>mdi-dots-horizontal </v-icon>
            </v-btn>
          </template>
          <v-list>
            <v-list-item class="px-0">
              <v-btn
                @click.stop="handleGoTOAction(item, 'edit')"
                class="d-flex w-100 justify-start px-5"
                flat
              >
                <editIcon
                  class="my-auto cursor-pointer me-2"
                  :color="'#AFAACB'"
                  :width="20"
                  :height="20"
                />
                <p>Edit</p>
              </v-btn>
            </v-list-item>
            <v-list-item class="px-0">
              <v-btn
                @click.stop="openDeleteModal(item)"
                class="d-flex w-100 justify-start px-5"
                flat
              >
                <deleteIcon
                  class="my-auto cursor-pointer me-2"
                  :color="'#AFAACB'"
                  :width="20"
                  :height="20"
                />
                <p>Delete</p>
              </v-btn>
            </v-list-item>
            <v-list-item class="px-0">
              <v-btn
                class="d-flex w-100 justify-start px-5"
                flat
                @click.stop="handleGoTOAction(item, 'view')"
              >
                <ViewIcon
                  class="my-auto cursor-pointer me-2"
                  :color="'#AFAACB'"
                  :width="20"
                  :height="20"
                />
                <p>View Details</p>
              </v-btn>
            </v-list-item>
          </v-list>
        </v-menu>
      </template>
    </v-data-table>
  </div>
</template>

<style>
.green--tag {
  color: #27ae60;
  background-color: rgba(39, 174, 96, 0.1);
  border-radius: 8px;
}
.price {
  color: #21094a;
  font-family: Roboto;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
}
.QTY {
  font-family: Roboto;
  font-size: 16px;
  font-style: normal;
  font-weight: 400;
}
.QTY.low {
  color: #eb5757;
}

.type {
  color: #7066a2;
  font-family: Roboto;
  font-size: 16px;
  font-style: normal;
  font-weight: 400;
}

.category {
  color: #21094a;
  font-family: Roboto;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
}

.product {
  color: var(--Black, #21094a);
  font-family: Roboto;
  font-size: 14px;
  font-style: normal;
  font-weight: 400;
}

.SKU {
  color: #21094a;
  font-family: Roboto;
  font-size: 16px;
  font-style: normal;
  font-weight: 500;
}

.checkBox {
  border-right: 1px #afaacb solid;
}

.listin-table {
  border-radius: 8px;
}

.listin-table thead tr:first-child {
  background-color: #9089b233;
  color: #21094a;
}

.listin-table tr > td:first-child {
  border-right: 1px solid #afaacb;
}
</style>
